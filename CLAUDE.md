# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Build and Development Commands

### Initial Setup
```bash
# Install dependencies and setup git hooks
npm install

# Bootstrap all packages with dependencies
npm run bootstrap

# Build all packages (creates npm shrinkwrap files)
npm run build

# Full reset (clean, correct deps, bootstrap, build)
npm run reset
```

### Common Development Tasks
```bash
# Validate new or modified products
npm run validate

# Correct dependencies to 'latest' version
npm run correct:deps

# Clean build artifacts
npm run clean        # Basic clean with nx reset
npm run clean:full   # Full clean including lerna clean

# Dry run lerna version to preview changes
npm run lerna:dry-run
```

### Creating New Products
```bash
# Create new product structure
sh scripts/createNewproduct.sh <folder_path>

# Then navigate to the new product and setup
cd <folder_path>
npm install
npm shrinkwrap
```

## Architecture Overview

This is a Lerna/Nx monorepo managing product catalog packages for the `@zerobias-org` namespace. Each package represents a vendor/product integration with standardized metadata.

### Package Structure
Each product package (`package/<vendor>/<product>/`) contains:
- `package.json` - NPM package definition following naming convention `@zerobias-org/product-<vendor>-<code>`
- `catalog.yml` - Product catalog data
- `index.yml` - Product metadata with fields like name, homepageUrl, dataLoaderVersion
- `logo.svg` - Product logo
- `npm-shrinkwrap.json` - Dependency lock file
- `CHANGELOG.md` - Auto-generated by Lerna

### Key Architectural Decisions
- **Independent Versioning**: Each package versioned independently via Lerna
- **Automated Publishing**: GitHub Actions publishes to GitHub Packages registry
- **Validation**: Custom TypeScript validator ensures package structure compliance
- **Conventional Commits**: Enforced via Husky hooks for automated changelog generation
- **Dependency Management**: Custom script corrects all dependencies to 'latest' version

### Publishing Workflow
1. Development happens on feature branches
2. PRs target the `dev` branch (not `main`)
3. Conventional commits trigger appropriate version bumps
4. GitHub Actions handle publishing when PRs are merged
5. Products start at version `0.0.0` and require explicit `premajor` labeling to reach `1.0.0`

### Authentication
Set `ZB_TOKEN` environment variable with ZeroBias API key for npm registry authentication.

### Important Notes
- The repository transitioned from `@auditlogic` to `@zerobias-org` namespace
- No traditional test framework is configured - validation is done via custom scripts
- Husky pre-commit hooks run validation and enforce commit conventions
- Products are published to GitHub Packages registry, not public npm

## Product Package Structure

Product packages follow one of two organizational patterns:

### Pattern 1: Direct Product Structure
`package/<vendor>/<product>/`
- Used for single-product vendors (e.g., `slack/slack/`, `datadog/datadog/`)
- Used for independent products from multi-product vendors (e.g., `hashicorp/vault/`, `cisco/duo/`)
- **parentType**: `vendor` (product's parent is the vendor)

### Pattern 2: Suite Structure
`package/<vendor>/<suite>/<product>/`
- Used for large product ecosystems organized into logical suites
- Examples: `microsoft/azure/policy/`, `google/gcp/bigquery/`, `amazon/aws/ec2/`
- **parentType**: `suite` (product's parent is the suite, not the vendor directly)

Each product package contains the same standardized files regardless of organizational pattern:

### Required Files

#### 1. `catalog.yml`
Defines the product and its available operations/APIs:
```yaml
Product:
  name: <Product Display Name>
  versions: [0.0.0]  # Always starts at 0.0.0
  package: <vendor>.<product>
  description: |-
    <Product description>
  link: <Product URL>
  contentType: json  # Always json
Operations:
  <operationName>:
    description: |-
      <Operation description>
    versions:
      from: <version>  # Starting version
      to: <version>    # Optional ending version
    link: <API documentation URL>
    example:
      inputs: [{}]   # Array of example input objects
      outputs: [{}]  # Array of expected output objects
```

**Note**: Some products have `Operations: {}` when they don't expose APIs (data-only products).

#### 2. `index.yml`
Contains comprehensive product metadata with structure-dependent fields:

**For Direct Product Structure (parentType: vendor):**
```yaml
id: <UUID>
name: <Product Name>
type: product
ownerId: <UUID>
created: <ISO timestamp>
updated: <ISO timestamp>
code: <product-code>
status: active
description: <Product description>
logo: <Logo URL>
url: <Product URL>
vendorId: <Vendor UUID>
vendorCode: <vendor-code>
parentType: vendor
tags: []
segments: [<Segment UUIDs>]
factoryTypes: [software]
hostingTypes: []
environment: <dev|qa|prod>
hostname: <API hostname>
cpeProducts: [<CPE identifiers>]  # Optional
aliases: []  # Optional alternative names
```

**For Suite Structure (parentType: suite):**
```yaml
id: <UUID>
name: <Product Name>
type: product
ownerId: <UUID>
created: <ISO timestamp>
updated: <ISO timestamp>
code: <product-code>
status: active
description: <Product description>
logo: <Logo URL>
url: <Product URL>
vendorId: <Vendor UUID>
vendorCode: <vendor-code>
parentType: suite
suiteId: <Suite UUID>
suiteCode: <suite-code>
tags: []
segments: [<Segment UUIDs>]
factoryTypes: [software]
hostingTypes: []
environment: <dev|qa|prod>
hostname: <API hostname>
cpeProducts: [<CPE identifiers>]  # Optional
```

#### 3. `package.json`
NPM package configuration:
```json
{
  "name": "@zerobias-org/product-<vendor>-<product>",
  "version": "<semver>",
  "description": "Product package for vendor <vendor>",
  "dependencies": {
    "@zerobias-org/segment-<segment>": "latest",
    "@zerobias-org/vendor-<vendor>": "^<version>"
  },
  "files": ["index.yml", "catalog.yml"],
  "auditmation": {
    "package": "<vendor>.<product>",
    "import-artifact": "product",
    "dataloader-version": "<version>"
  }
}
```

#### 4. `logo.svg` or `logo.png`
Product logo file

#### 5. `npm-shrinkwrap.json`
Dependency lock file (generated by `npm shrinkwrap`)

#### 6. `CHANGELOG.md`
Auto-generated by Lerna based on conventional commits

### Operation Examples

Operations in catalog.yml can range from simple to complex:

**Simple operation (no parameters):**
```yaml
accounts.showAccount:
  description: Shows all the information about your account.
  versions:
    from: 2.0.0
  link: https://developer.example.com/api/accounts
  example:
    inputs: [{}]
    outputs: [{...}]
```

**Complex operation (with parameters):**
```yaml
auth.alicloud.CreateRole:
  description: |-
    Multi-line description explaining the operation...
  versions:
    from: 0.0.0
  link: https://api-docs-url
  example:
    inputs: [
      {
        "arn": "acs:ram::5138828231865461:role/dev-role",
        "policies": ["dev", "prod"]
      }
    ]
    outputs: [{}]
```

### Validation Requirements
The `scripts/validate.ts` script enforces:
- Package name format: `@zerobias-org/product-<vendor>-<code>`
- Required fields in all YAML files
- Proper UUID formats
- No placeholder values (e.g., `{name}` in descriptions)
- Valid package.json structure